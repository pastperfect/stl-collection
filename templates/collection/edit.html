{% extends 'base.html' %}
{% load collection_filters %}

{% block title %}Edit {{ image.name }} - STL Collection{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header">
                <h3><i class="bi bi-pencil"></i> Edit Image: {{ image.name }}</h3>
            </div>
            <div class="card-body">
                {% if image.image %}
                <div class="text-center mb-4">
                    <img src="{{ image.image.url }}" class="img-fluid" style="max-height: 300px;" alt="{{ image.name }}">
                </div>
                {% endif %}

                <form method="post">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="{{ form.name.id_for_label }}" class="form-label">Name *</label>
                        {{ form.name }}
                        {% if form.name.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.name.errors.0 }}
                            </div>
                        {% endif %}
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.publisher.id_for_label }}" class="form-label">Publisher</label>
                                {{ form.publisher }}
                                {% if form.publisher.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.publisher.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.range.id_for_label }}" class="form-label">Range</label>
                                {{ form.range }}
                                {% if form.range.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.range.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.folder_location.id_for_label }}" class="form-label">Folder Location</label>
                        {{ form.folder_location }}
                        {% if form.folder_location.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.folder_location.errors.0 }}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Quick Tags Section -->
                    <div class="mb-3">
                        <div class="card">
                            <div class="card-header">
                                <div class="row align-items-center">
                                    <div class="col-md-3">
                                        <h6 class="mb-0">
                                            <i class="bi bi-tags"></i> Tags
                                        </h6>
                                        <small class="text-muted">Click tags to add or remove</small>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="tagTypeFilter" class="form-label mb-1 small">Filter by Type</label>
                                        <select class="form-select form-select-sm" id="tagTypeFilter" onchange="filterQuickTags()">
                                            <option value="">All Tag Types</option>
                                            {% for tag_type in tag_types %}
                                            <option value="{{ tag_type.id }}" 
                                                    data-has-reference="{% if tag_type.reference_tagtypes.exists %}true{% else %}false{% endif %}"
                                                    {% if tag_type.id|stringformat:"s" == tag_type_filter %}selected{% endif %}>
                                                {{ tag_type.name }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-3" id="referenceTagFilterContainer" style="{% if not selected_tag_type_obj or not selected_tag_type_obj.reference_tagtypes.exists %}display: none;{% endif %}">
                                        <label for="referenceTagFilter" class="form-label mb-1 small">Filter by Reference</label>
                                        <select class="form-select form-select-sm" id="referenceTagFilter" onchange="filterQuickTags()">
                                            <option value="">All References</option>
                                            <option value="none" {% if reference_tag_filter == 'none' %}selected{% endif %}>No Reference</option>
                                            {% for ref_tag in reference_tags %}
                                            <option value="{{ ref_tag.id }}" {% if reference_tag_filter == ref_tag.id|stringformat:"s" %}selected{% endif %}>
                                                {{ ref_tag.name }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="tagSearchInput" class="form-label mb-1 small">Search Tags</label>
                                        <div class="input-group input-group-sm">
                                            <input type="text" class="form-control" id="tagSearchInput" placeholder="Type to search..." aria-label="Search tags">
                                            <button class="btn btn-outline-secondary" type="button" id="clearSearchBtn" style="display: none;" aria-label="Clear search">
                                                <i class="bi bi-x"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- Current Tags -->
                                <div class="mb-2">
                                    <strong class="small">Assigned Tags:</strong>
                                    <div class="mt-2" id="currentTagsContainer">
                                        {% for tag in entry.tags.all %}
                                        <span class="badge quick-tag assigned" 
                                            style="background-color: {{ tag.get_color }} !important; color: {{ tag.get_text_color }} !important; cursor: pointer;"
                                            data-tag-id="{{ tag.id }}" 
                                            data-tag-name="{{ tag.name }}">
                                            {{ tag.name }} <i class="bi bi-x"></i>
                                        </span>
                                        {% empty %}
                                        <small class="text-muted">No tags assigned</small>
                                        {% endfor %}
                                    </div>
                                </div>
                                <hr>
                                <!-- Available Tags -->
                                <div class="mt-2" id="quickTagsContainer">
                                    {% for tag in quick_tags %}
                                    <span class="badge quick-tag" 
                                        style="background-color: {{ tag.get_color }}; color: {{ tag.get_text_color }}; cursor: pointer;"
                                        data-tag-id="{{ tag.id }}" 
                                        data-tag-name="{{ tag.name }}" 
                                        data-tag-type="{{ tag.tag_type.id }}">
                                        {{ tag.name }}
                                    </span>
                                    {% endfor %}
                                </div>
                                <div class="mt-2" id="tagLimitMessage" style="display: none;">
                                    <small class="text-muted">Showing first 50 tags. Use search or filters to find more.</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.notes.id_for_label }}" class="form-label">Notes</label>
                        {{ form.notes }}
                        {% if form.notes.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.notes.errors.0 }}
                            </div>
                        {% endif %}
                    </div>                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'collection:gallery' %}" class="btn btn-secondary me-md-2">
                            <i class="bi bi-arrow-left"></i> Back to Gallery
                        </a>
                        <a href="{% url 'image_details:detail' image.id %}" class="btn btn-info me-md-2">
                            <i class="bi bi-eye"></i> View Details
                        </a>
                        <a href="{% url 'collection:delete' image.id %}" class="btn btn-danger me-md-2" 
                           onclick="return confirm('Are you sure you want to delete this image? This action cannot be undone.')">
                            <i class="bi bi-trash"></i> Delete Image
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
            <div class="card-footer">
                <small class="text-muted">
                    <i class="bi bi-clock"></i> Uploaded: {{ image.upload_date|date:"F d, Y g:i A" }}
                </small>
            </div>
        </div>
    </div>
</div>

<style>
.quick-tag {
    cursor: pointer;
    transition: all 0.2s ease;
    margin: 0.2rem;
}
.quick-tag:hover {
    transform: scale(1.05);
    opacity: 0.8;
}
.quick-tag.assigned:hover {
    opacity: 0.7;
}
</style>

<script>
let searchTimeout = null;

function filterQuickTags() {
    const tagTypeFilter = document.getElementById('tagTypeFilter');
    const referenceTagFilter = document.getElementById('referenceTagFilter');
    const referenceTagFilterContainer = document.getElementById('referenceTagFilterContainer');
    const selectedType = tagTypeFilter.value;
    const selectedOption = tagTypeFilter.options[tagTypeFilter.selectedIndex];
    const hasReference = selectedOption.getAttribute('data-has-reference') === 'true';
    
    const currentUrl = new URL(window.location);
    
    if (selectedType) {
        currentUrl.searchParams.set('tag_type', selectedType);
        
        if (hasReference && referenceTagFilter) {
            const selectedReference = referenceTagFilter.value;
            if (selectedReference) {
                currentUrl.searchParams.set('reference_tag', selectedReference);
            } else {
                currentUrl.searchParams.delete('reference_tag');
            }
        } else {
            currentUrl.searchParams.delete('reference_tag');
        }
    } else {
        currentUrl.searchParams.delete('tag_type');
        currentUrl.searchParams.delete('reference_tag');
    }
    
    window.location.href = currentUrl.toString();
}

// Debounced search function for quick tags
function searchQuickTags() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        const searchInput = document.getElementById('tagSearchInput');
        const clearBtn = document.getElementById('clearSearchBtn');
        const searchText = searchInput.value.toLowerCase().trim();
        const quickTags = document.querySelectorAll('#quickTagsContainer .quick-tag');
        const tagLimitMessage = document.getElementById('tagLimitMessage');
        let visibleCount = 0;
        
        // Show/hide clear button
        clearBtn.style.display = searchText ? 'block' : 'none';
        
        // If no search text, show only first 50 tags
        if (!searchText) {
            quickTags.forEach((tag, index) => {
                if (index < 50) {
                    tag.style.display = '';
                    visibleCount++;
                } else {
                    tag.style.display = 'none';
                }
            });
            // Show limit message if there are more than 50 tags
            if (tagLimitMessage) {
                tagLimitMessage.style.display = quickTags.length > 50 ? 'block' : 'none';
            }
        } else {
            // Search across all tags
            quickTags.forEach(tag => {
                const tagName = tag.dataset.tagName.toLowerCase();
                if (tagName.includes(searchText)) {
                    tag.style.display = '';
                    visibleCount++;
                } else {
                    tag.style.display = 'none';
                }
            });
            // Hide limit message when searching
            if (tagLimitMessage) {
                tagLimitMessage.style.display = 'none';
            }
        }
        
        // Show/hide no results message
        let noResultsMsg = document.getElementById('noResultsMessage');
        if (visibleCount === 0 && searchText) {
            if (!noResultsMsg) {
                noResultsMsg = document.createElement('div');
                noResultsMsg.id = 'noResultsMessage';
                noResultsMsg.className = 'text-muted small mt-2';
                noResultsMsg.textContent = 'No tags found matching your search.';
                document.getElementById('quickTagsContainer').appendChild(noResultsMsg);
            }
        } else if (noResultsMsg) {
            noResultsMsg.remove();
        }
    }, 200);
}

// Clear search function
function clearSearch() {
    const searchInput = document.getElementById('tagSearchInput');
    searchInput.value = '';
    searchQuickTags();
}

document.addEventListener('DOMContentLoaded', function() {
    // Handle quick tag clicks (add tags)
    document.querySelectorAll('.quick-tag:not(.assigned)').forEach(tag => {
        tag.addEventListener('click', function() {
            const tagId = this.dataset.tagId;
            const tagName = this.dataset.tagName;
            addTag(tagId, tagName);
        });
    });
    
    // Handle assigned tag clicks (remove tags)
    document.querySelectorAll('.quick-tag.assigned').forEach(tag => {
        tag.addEventListener('click', function() {
            const tagId = this.dataset.tagId;
            removeTag(tagId, this);
        });
    });
    
    function addTag(tagId, tagName) {
        const entryId = {{ entry.id }};
        
        fetch('{% url "tag_assign:quick_assign" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                entry_id: entryId,
                tag_id: tagId,
                action: 'add'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(`Added "${tagName}"`, 'success');
                setTimeout(() => location.reload(), 500);
            } else {
                showToast('Error: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            showToast('Network error occurred', 'danger');
        });
    }
    
    function removeTag(tagId, element) {
        const entryId = {{ entry.id }};
        
        fetch('{% url "tag_assign:quick_assign" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                entry_id: entryId,
                tag_id: tagId,
                action: 'remove'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Tag removed', 'success');
                setTimeout(() => location.reload(), 500);
            } else {
                showToast('Error: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            showToast('Network error occurred', 'danger');
        });
    }
    
    function showToast(message, type) {
        const toastContainer = document.getElementById('toastContainer') || createToastContainer();
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-bg-${type} border-0`;
        toast.setAttribute('role', 'alert');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
    }
    
    function createToastContainer() {
        const container = document.createElement('div');
        container.id = 'toastContainer';
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        container.style.zIndex = '1056';
        document.body.appendChild(container);
        return container;
    }
    
    // Initialize search functionality
    const searchInput = document.getElementById('tagSearchInput');
    const clearBtn = document.getElementById('clearSearchBtn');
    
    if (searchInput) {
        searchInput.addEventListener('input', searchQuickTags);
    }
    
    if (clearBtn) {
        clearBtn.addEventListener('click', clearSearch);
    }
    
    // Initialize tag display (show only first 50)
    const quickTags = document.querySelectorAll('#quickTagsContainer .quick-tag');
    const tagLimitMessage = document.getElementById('tagLimitMessage');
    quickTags.forEach((tag, index) => {
        if (index >= 50) {
            tag.style.display = 'none';
        }
    });
    if (tagLimitMessage && quickTags.length > 50) {
        tagLimitMessage.style.display = 'block';
    }
});
</script>

{% endblock %}
